import ScrollText from '@/components/ScrollText'
import SearchBar from '@/components/SearchBar'
import { Avatar, AvatarFallback, AvatarImage } from '@/components/ui/avatar'
import { Button } from '@/components/ui/button'
import {
   DropdownMenu,
   DropdownMenuContent,
   DropdownMenuItem,
   DropdownMenuSub,
   DropdownMenuSubContent,
   DropdownMenuSubTrigger,
   DropdownMenuTrigger,
} from '@/components/ui/dropdown-menu'
import {
   HoverCard,
   HoverCardContent,
   HoverCardTrigger,
} from '@/components/ui/hover-card'
import {
   Select,
   SelectContent,
   SelectItem,
   SelectTrigger,
   SelectValue,
} from '@/components/ui/select'
import type { LatLng } from '@/interfaces/map/location.interface'
import type { RootState } from '@/redux/store'
import { formatTimeDifference, type Lang } from '@/utils/formats/time.utils'
import { unitConvert } from '@/utils/formats/unit.convert.utils'
import { createFileRoute } from '@tanstack/react-router'
import {
   CalendarDays,
   ChevronsLeft,
   ChevronsRight,
   Clock4,
   MoreVertical,
   Timer,
} from 'lucide-react'
import { useState } from 'react'
import { useSelector } from 'react-redux'

interface Profile {
   sub: string
   firstName: string
   lastName?: string
   phoneNumber: string
   profilePhoto?: string
}

interface Order {
   orderId: string
   providerProfile: Profile
   clientProfile: Profile
   driverPickUpProfile?: Profile
   driverDeliveryProfile?: Profile
   pickupLocation: LatLng
   deliveryLocation: LatLng
   status: 'PENDING' | 'CONFIRMED' | 'CANCELLED'
   paymentStatus: 'UNPAID' | 'PAID' | 'REFUNDED'
   deliveryStatus?: 'PENDING' | 'IN_TRANSIT' | 'DELIVERED'
   createdAt: Date
   updatedAt: Date

   items: CommandProduct[]
}

interface CommandProduct {
   commandId: string
   productId: string
   productName: string
   productImage?: string
   sku?: string // pour g√©rer les variantes
   quantity: number
   unitPrice: number
   discount?: number
   taxRate?: number
}

const fakeOrders: Order[] = [
   {
      orderId: 'ORD-20251227-001',
      providerProfile: {
         sub: 'PROV-123',
         firstName: 'Ranaivo',
         lastName: 'Rakoto',
         phoneNumber: '+261340123456',
      },
      clientProfile: {
         sub: 'CLI-456',
         firstName: 'Hery',
         lastName: 'Andrian',
         phoneNumber: '+261330987654',
      },
      driverPickUpProfile: {
         sub: 'DRV-789',
         firstName: 'Jean',
         lastName: 'Rakotomalala',
         phoneNumber: '+261320112233',
      },
      driverDeliveryProfile: {
         sub: 'DRV-790',
         firstName: 'Michel',
         lastName: 'Rasoa',
         phoneNumber: '+261320445566',
      },
      pickupLocation: { latitude: -18.8792, longitude: 47.5079 },
      deliveryLocation: { latitude: -18.9137, longitude: 47.5361 },
      status: 'CONFIRMED',
      paymentStatus: 'PAID',
      deliveryStatus: 'IN_TRANSIT',
      createdAt: new Date('2025-12-27T10:00:00Z'),
      updatedAt: new Date('2025-12-27T11:00:00Z'),
      items: [
         {
            commandId: 'CMD-001',
            productId: 'PROD-001',
            productName: 'Flash 2 30Go',
            sku: 'FLASH2-30',
            quantity: 3,
            unitPrice: 100,
            discount: 10,
            taxRate: 5,
         },
         {
            commandId: 'CMD-002',
            productId: 'PROD-002',
            productName: 'Flash 2 60Go',
            sku: 'FLASH2-60',
            quantity: 1,
            unitPrice: 180,
            discount: 0,
            taxRate: 5,
         },
      ],
   },
   {
      orderId: 'ORD-20251227-002',
      providerProfile: {
         sub: 'PROV-124',
         firstName: 'Lala',
         lastName: 'Rasolofoniaina',
         phoneNumber: '+261340223344',
      },
      clientProfile: {
         sub: 'CLI-457',
         firstName: 'Mamy',
         lastName: 'Rakotondrabe',
         phoneNumber: '+261330998877',
      },
      driverPickUpProfile: {
         sub: 'DRV-791',
         firstName: 'Faly',
         lastName: 'Ranaivo',
         phoneNumber: '+261320667788',
      },
      driverDeliveryProfile: {
         sub: 'DRV-792',
         firstName: 'Bako',
         lastName: 'Rasoa',
         phoneNumber: '+261320556677',
      },
      pickupLocation: { latitude: -18.89, longitude: 47.51 },
      deliveryLocation: { latitude: -18.92, longitude: 47.54 },
      status: 'PENDING',
      paymentStatus: 'UNPAID',
      deliveryStatus: 'PENDING',
      createdAt: new Date('2025-12-27T09:00:00Z'),
      updatedAt: new Date('2025-12-27T09:15:00Z'),
      items: [
         {
            commandId: 'CMD-003',
            productId: 'PROD-003',
            productName: 'Smartphone X 128Go',
            sku: 'SMX-128',
            quantity: 2,
            unitPrice: 300,
            discount: 20,
            taxRate: 10,
         },
      ],
   },
   {
      orderId: 'ORD-20251227-003',
      providerProfile: {
         sub: 'PROV-125',
         firstName: 'Sitraka',
         lastName: 'Rakotoniaina',
         phoneNumber: '+261340334455',
      },
      clientProfile: {
         sub: 'CLI-458',
         firstName: 'Hanta',
         lastName: 'Rakotomamonjy',
         phoneNumber: '+261330887766',
      },
      driverPickUpProfile: {
         sub: 'DRV-793',
         firstName: 'Tiana',
         lastName: 'Rakotoarisoa',
         phoneNumber: '+261320778899',
      },
      driverDeliveryProfile: {
         sub: 'DRV-794',
         firstName: 'Solo',
         lastName: 'Rasolonjatovo',
         phoneNumber: '+261320889900',
      },
      pickupLocation: { latitude: -18.885, longitude: 47.515 },
      deliveryLocation: { latitude: -18.925, longitude: 47.545 },
      status: 'CONFIRMED',
      paymentStatus: 'PAID',
      deliveryStatus: 'IN_TRANSIT',
      createdAt: new Date('2025-12-27T08:30:00Z'),
      updatedAt: new Date('2025-12-27T09:00:00Z'),
      items: [
         {
            commandId: 'CMD-004',
            productId: 'PROD-004',
            productName: 'Tablet A 64Go',
            sku: 'TAB-A64',
            quantity: 1,
            unitPrice: 250,
            discount: 0,
            taxRate: 8,
         },
         {
            commandId: 'CMD-005',
            productId: 'PROD-005',
            productName: 'Smartwatch Z',
            sku: 'SW-Z',
            quantity: 2,
            unitPrice: 120,
            discount: 5,
            taxRate: 8,
         },
      ],
   },
   {
      orderId: 'ORD-20251227-004',
      providerProfile: {
         sub: 'PROV-126',
         firstName: 'Feno',
         lastName: 'Rakotondrainy',
         phoneNumber: '+261340445566',
      },
      clientProfile: {
         sub: 'CLI-459',
         firstName: 'Miora',
         lastName: 'Andrianantenaina',
         phoneNumber: '+261330776655',
      },
      driverPickUpProfile: {
         sub: 'DRV-795',
         firstName: 'Rija',
         lastName: 'Rakotomanga',
         phoneNumber: '+261320998811',
      },
      driverDeliveryProfile: {
         sub: 'DRV-796',
         firstName: 'Lova',
         lastName: 'Rakotovao',
         phoneNumber: '+261320665544',
      },
      pickupLocation: { latitude: -18.892, longitude: 47.52 },
      deliveryLocation: { latitude: -18.93, longitude: 47.55 },
      status: 'CANCELLED',
      paymentStatus: 'REFUNDED',
      deliveryStatus: 'PENDING',
      createdAt: new Date('2025-12-26T14:00:00Z'),
      updatedAt: new Date('2025-12-26T16:00:00Z'),
      items: [
         {
            commandId: 'CMD-006',
            productId: 'PROD-006',
            productName: 'Laptop B 256Go',
            sku: 'LAP-B256',
            quantity: 1,
            unitPrice: 800,
            discount: 50,
            taxRate: 15,
         },
      ],
   },
   {
      orderId: 'ORD-20251227-005',
      providerProfile: {
         sub: 'PROV-127',
         firstName: 'Hery',
         lastName: 'Rakotoharisoa',
         phoneNumber: '+261340556677',
      },
      clientProfile: {
         sub: 'CLI-460',
         firstName: 'Tiana',
         lastName: 'Rakotomalala',
         phoneNumber: '+261330665544',
      },
      driverPickUpProfile: {
         sub: 'DRV-797',
         firstName: 'Ando',
         lastName: 'Rakotomanga',
         phoneNumber: '+261320443322',
      },
      driverDeliveryProfile: {
         sub: 'DRV-798',
         firstName: 'Mamy',
         lastName: 'Rasoanaivo',
         phoneNumber: '+261320554433',
      },
      pickupLocation: { latitude: -18.895, longitude: 47.525 },
      deliveryLocation: { latitude: -18.935, longitude: 47.555 },
      status: 'CONFIRMED',
      paymentStatus: 'PAID',
      deliveryStatus: 'IN_TRANSIT',
      createdAt: new Date('2025-12-27T07:00:00Z'),
      updatedAt: new Date('2025-12-27T08:00:00Z'),
      items: [
         {
            commandId: 'CMD-007',
            productId: 'PROD-007',
            productName: 'Headphones M',
            sku: 'HP-M',
            quantity: 2,
            unitPrice: 60,
            discount: 0,
            taxRate: 5,
         },
         {
            commandId: 'CMD-008',
            productId: 'PROD-008',
            productName: 'Charger Fast 20W',
            sku: 'CH-20W',
            quantity: 3,
            unitPrice: 25,
            discount: 0,
            taxRate: 5,
         },
      ],
   },
]

export const Route = createFileRoute('/app/mart/commands')({
   component: RouteComponent,
})

function RouteComponent() {
   const [searchValue, setSearchValue] = useState('')
   const [pageSetting, setPageSetting] = useState<{
      page: number
      pageSize: number
   }>()

   const locale = useSelector((state: RootState) => state.language.locale)

   const optionPickUpDate: Intl.DateTimeFormatOptions = {
      day: '2-digit',
      month: 'short',
      year: 'numeric',
   }

   const optionPickUpTime: Intl.DateTimeFormatOptions = {
      hour: '2-digit',
      minute: '2-digit',
      hour12: false,
   }

   const getLocalDateFormat = () => {
      if (locale === 'en') return 'en-US'
      else if (locale === 'fr') return 'fr-FR'
      else if (locale === 'mg') return 'mg-MG'
      else if (locale === 'zh') return 'zh-CN'
      else return 'en-US'
   }

   return (
      <div className='space-y-2'>
         <SearchBar
            filterItems={[]}
            refetchFn={() => {}}
            searchFilter={[]}
            setSearchFilter={() => {}}
            setSearchValue={setSearchValue}
            totalCount={5}
         />

         <div className='space-y-2 overflow-auto'>
            <div className='flex items-center bg-[var(--background-secondary)] p-2 rounded-md shadow min-w-fit'>
               <div className='min-w-25 max-w-25 font-bold'>Created At</div>
               <div className='min-w-45 max-w-45 font-bold'>Client</div>
               <div className='min-w-25 max-w-25 font-bold'>Driver</div>
               <div className='min-w-20 max-w-20 font-bold'>Items</div>
               <div className='min-w-35 max-w-35 font-bold'>Status</div>
               <div className='min-w-35 max-w-35 font-bold'>Payment status</div>
               <div className='min-w-35 max-w-35 font-bold'>
                  Delivery status
               </div>
               <p className='min-w-35 max-w-35 font-bold'>Total price</p>
            </div>
            <div className='space-y-2'>
               {fakeOrders.map((data) => (
                  <div>
                     <label className='space-y-2'>
                        <input type='checkbox' className='hidden peer' />
                        <div className='flex items-center bg-[var(--background-secondary)] p-2 rounded-md shadow min-w-fit'>
                           {/** Created At */}
                           <div className='text-xs space-y-1 min-w-25 max-w-25'>
                              <div className='flex items-center gap-1'>
                                 <Clock4 className='size-4' />
                                 {new Date(data.createdAt).toLocaleTimeString(
                                    getLocalDateFormat(),
                                    optionPickUpTime,
                                 )}
                              </div>
                              <div className='flex items-center gap-1'>
                                 <CalendarDays className='size-4' />
                                 {new Date(data.createdAt).toLocaleDateString(
                                    getLocalDateFormat(),
                                    optionPickUpDate,
                                 )}
                              </div>
                              <div className='flex items-center gap-1'>
                                 <Timer className='size-4' />
                                 {formatTimeDifference(
                                    new Date(data.createdAt).getTime(),
                                    locale as Lang,
                                 )}
                              </div>
                           </div>

                           {/** Client */}
                           <div className='min-w-45 max-w-45 flex items-center gap-2'>
                              <Avatar className='size-10'>
                                 <AvatarImage
                                    src={data.clientProfile.profilePhoto}
                                 />
                                 <AvatarFallback>
                                    {data.clientProfile.firstName
                                       .charAt(0)
                                       .toUpperCase()}
                                 </AvatarFallback>
                              </Avatar>

                              <div>
                                 <ScrollText
                                    text={`${data.clientProfile.firstName} ${data.clientProfile.lastName || ''}`}
                                    className='max-w-30 font-bold'
                                 />
                                 <ScrollText
                                    text={`${data.clientProfile.phoneNumber}`}
                                    className='max-w-30 text-xs'
                                 />
                              </div>
                           </div>

                           {/** Driver */}
                           <div className='flex items-center -space-x-2 min-w-25 max-w-25'>
                              {data.driverPickUpProfile && (
                                 <HoverCard>
                                    <HoverCardTrigger>
                                       <Avatar className='border-2 border-[var(--background-secondary)] size-10'>
                                          <AvatarImage
                                             src={
                                                data.driverPickUpProfile
                                                   .profilePhoto
                                             }
                                          />
                                          <AvatarFallback>
                                             {data.driverPickUpProfile.firstName
                                                .charAt(0)
                                                .toUpperCase()}
                                             {data.driverPickUpProfile.lastName
                                                ?.charAt(0)
                                                .toUpperCase()}
                                          </AvatarFallback>
                                       </Avatar>
                                    </HoverCardTrigger>
                                    <HoverCardContent>
                                       <p>Pickup driver</p>
                                       <div className='flex items-center gap-2'>
                                          <Avatar>
                                             <AvatarImage
                                                src={
                                                   data.driverPickUpProfile
                                                      .profilePhoto
                                                }
                                             />
                                             <AvatarFallback>
                                                {data.driverPickUpProfile.firstName
                                                   .charAt(0)
                                                   .toUpperCase()}
                                                {data.driverPickUpProfile.lastName
                                                   ?.charAt(0)
                                                   .toUpperCase()}
                                             </AvatarFallback>
                                          </Avatar>
                                          <div>
                                             <ScrollText
                                                text={`${data.driverPickUpProfile.firstName} ${data.driverPickUpProfile.lastName || ''}`}
                                                className='max-w-30 font-bold'
                                             />
                                             <ScrollText
                                                text={`${data.driverPickUpProfile.phoneNumber}`}
                                                className='max-w-30 text-xs'
                                             />
                                          </div>
                                       </div>
                                    </HoverCardContent>
                                 </HoverCard>
                              )}
                              {data.driverDeliveryProfile && (
                                 <HoverCard>
                                    <HoverCardTrigger>
                                       <Avatar className='border-2 border-[var(--background-secondary)] size-10'>
                                          <AvatarImage
                                             src={
                                                data.driverDeliveryProfile
                                                   .profilePhoto
                                             }
                                          />
                                          <AvatarFallback>
                                             {data.driverDeliveryProfile.firstName
                                                .charAt(0)
                                                .toUpperCase()}
                                             {data.driverDeliveryProfile.lastName
                                                ?.charAt(0)
                                                .toUpperCase()}
                                          </AvatarFallback>
                                       </Avatar>
                                    </HoverCardTrigger>
                                    <HoverCardContent>
                                       <p>Delivery driver</p>
                                       <div className='flex items-center gap-2'>
                                          <Avatar>
                                             <AvatarImage
                                                src={
                                                   data.driverDeliveryProfile
                                                      .profilePhoto
                                                }
                                             />
                                             <AvatarFallback>
                                                {data.driverDeliveryProfile.firstName
                                                   .charAt(0)
                                                   .toUpperCase()}
                                                {data.driverDeliveryProfile.lastName
                                                   ?.charAt(0)
                                                   .toUpperCase()}
                                             </AvatarFallback>
                                          </Avatar>
                                          <div>
                                             <ScrollText
                                                text={`${data.driverDeliveryProfile.firstName} ${data.driverDeliveryProfile.lastName || ''}`}
                                                className='max-w-30 font-bold'
                                             />
                                             <ScrollText
                                                text={`${data.driverDeliveryProfile.phoneNumber}`}
                                                className='max-w-30 text-xs'
                                             />
                                          </div>
                                       </div>
                                    </HoverCardContent>
                                 </HoverCard>
                              )}
                              {!data.driverPickUpProfile &&
                                 !data.driverDeliveryProfile && (
                                    <div className='text-[var(--gray)]'>
                                       Undefined
                                    </div>
                                 )}
                           </div>

                           {/** Items */}
                           <div className='min-w-20 max-w-20 text-xl font-extrabold'>
                              {data.items.length.toString().padStart(3, '0')}
                           </div>

                           <div className='min-w-35 max-w-35'>
                              {data.status}
                           </div>
                           <div className='min-w-35 max-w-35'>
                              {data.paymentStatus}
                           </div>
                           <div className='min-w-35 max-w-35'>
                              {data.deliveryStatus}
                           </div>
                           <div className='min-w-35 max-w-35'>
                              {unitConvert(
                                 data.items.reduce<number>(
                                    (acc, value) =>
                                       acc + value.unitPrice * value.quantity,
                                    0,
                                 ),
                              )}{' '}
                              Ar
                           </div>

                           <div>
                              <DropdownMenu>
                                 <DropdownMenuTrigger asChild>
                                    <Button variant='ghost'>
                                       <MoreVertical />
                                    </Button>
                                 </DropdownMenuTrigger>
                                 <DropdownMenuContent>
                                    <DropdownMenuItem>Details</DropdownMenuItem>
                                    <DropdownMenuSub>
                                       <DropdownMenuSubTrigger>
                                          Change status
                                       </DropdownMenuSubTrigger>
                                       <DropdownMenuSubContent>
                                          <DropdownMenuItem>
                                             Option 1
                                          </DropdownMenuItem>
                                          <DropdownMenuItem>
                                             Option 2
                                          </DropdownMenuItem>
                                          <DropdownMenuItem>
                                             Option 3
                                          </DropdownMenuItem>
                                       </DropdownMenuSubContent>
                                    </DropdownMenuSub>
                                    <DropdownMenuItem>Delete</DropdownMenuItem>
                                 </DropdownMenuContent>
                              </DropdownMenu>
                           </div>
                        </div>

                        <div className='hidden peer-checked:block border-l-2 pl-5 space-y-2'>
                           <div className='bg-[var(--background-secondary)] p-2 rounded-md flex items-center'>
                              <div className='min-w-1/6 max-w-1/6 font-bold'>
                                 Name
                              </div>
                              <div className='min-w-1/6 max-w-1/6 font-bold'>
                                 Unit price
                              </div>
                              <div className='min-w-1/6 max-w-1/6 font-bold'>
                                 Quantity
                              </div>
                              <div className='min-w-1/6 max-w-1/6 font-bold'>
                                 Total
                              </div>
                              <div className='min-w-1/6 max-w-1/6 font-bold'>
                                 Discount
                              </div>
                              <div className='min-w-1/6 max-w-1/6 font-bold'>
                                 Tax rate
                              </div>
                           </div>

                           {data.items.map((item) => (
                              <div className='bg-[var(--background-secondary)] p-2 rounded-md flex items-center'>
                                 <div className='min-w-1/6 max-w-1/6 pr-2 font-bold truncate'>
                                    {item.productName}
                                 </div>
                                 <div className='min-w-1/6 max-w-1/6 pr-2'>
                                    {unitConvert(item.unitPrice)} Ar
                                 </div>
                                 <div className='min-w-1/6 max-w-1/6 pr-2'>
                                    {item.quantity.toString().padStart(3, '0')}
                                 </div>
                                 <div className='min-w-1/6 max-w-1/6 pr-2'>
                                    {unitConvert(
                                       item.unitPrice * item.quantity,
                                    )}{' '}
                                    Ar
                                 </div>
                                 <div className='min-w-1/6 max-w-1/6 pr-2'>
                                    {item.discount} %
                                 </div>
                                 <div className='min-w-1/6 max-w-1/6 pr-2'>
                                    {unitConvert(item.taxRate ?? 0)} Ar
                                 </div>
                              </div>
                           ))}
                        </div>
                     </label>
                  </div>
               ))}
            </div>
         </div>

         <div className='flex items-center justify-between'>
            <p className='text-xs text-[var(--gray)]'>Page 1 of 10</p>

            <div className='flex items-center gap-2'>
               <Select>
                  <SelectTrigger size='sm'>
                     Page size: <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                     {[10, 20, 30, 40, 50].map((value) => (
                        <SelectItem key={value} value={value.toString()}>
                           {value}
                        </SelectItem>
                     ))}
                  </SelectContent>
               </Select>

               <Button size={'sm'} variant={'outline'}>
                  <ChevronsLeft /> Previous
               </Button>
               <Button size={'sm'} variant={'outline'}>
                  Next <ChevronsRight />
               </Button>
            </div>
         </div>
      </div>
   )
}
