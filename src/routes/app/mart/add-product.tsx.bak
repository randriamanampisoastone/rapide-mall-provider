import AddMartProduct from '@/components/app/mart/addMartProduct/AddMartProduct'
import langue from '@/data/language/app/mart/AddMartProduct.json'
import SelectProductMainPhoto from '@/components/app/mart/addMartProduct/SelectProductMainPhoto'
import SelectProductPhotos from '@/components/app/mart/addMartProduct/SelectProductPhotos'
import { Button } from '@/components/ui/button'
import type { LatLng } from '@/interfaces/map/location.interface'
import { createFileRoute, useNavigate } from '@tanstack/react-router'
import { useEffect, useState } from 'react'
import useTranslate from '@/hooks/useTranslate'
import { Download, Plus, Save, Upload } from 'lucide-react'
import {
   DropdownMenu,
   DropdownMenuContent,
   DropdownMenuItem,
   DropdownMenuTrigger,
} from '@/components/ui/dropdown-menu'
import exportFromJSON from 'export-from-json'
import { useDispatch, useSelector } from 'react-redux'
import type { RootState } from '@/redux/store'
import { setFile } from '@/redux/slices/file.slice'

export const Route = createFileRoute('/app/mart/add-product')({
   component: RouteComponent,
})

function RouteComponent() {
   const translate = useTranslate(langue)
   const [phoneNumber, setPhoneNumber] = useState<string>('')
   const [brand, setBrand] = useState<string>('')
   const [productName, setProductName] = useState<string>('')
   const [category, setCategory] = useState<string>('') // Temporary
   const [description, setDescription] = useState<string>('')
   const [weight, setWeight] = useState<number>(0)
   const [width, setWidth] = useState<number>(0)
   const [height, setHeight] = useState<number>(0)
   const [length, setLength] = useState<number>(0)
   const [colors, setColors] = useState<string[]>([])
   const [price, setPrice] = useState<number>(0)
   const [quantity, setQuantity] = useState<number>(0)
   const [pickupLocation, setPickupLocation] = useState<LatLng | undefined>(
      undefined,
   )
   const [promotionDiscount, setPromotionDiscount] = useState<number>(0)
   const [mainPhoto, setMainPhoto] = useState<string>('')

   const navigate = useNavigate()
   const dispatch = useDispatch()
   const file = useSelector((state: RootState) => state.file.file)

   useEffect(() => {
      if (file) navigate({ to: '/app/mart/add-many-products' })
   }, [file])

   const handleDownloadFile = () => {
      const exportData = [
         {
            ['Phone number']: '+261 XX XX XXX XX',
            ['Brand']: 'brand name',
            ['Product name']: 'product name',
            ['Color']: 'blue, red, #0c0',
            ['Category']: 'Other or one of the existing categories',
            ['Weight (kg)']: 0.5,
            ['Width (cm)']: 10,
            ['Height (cm)']: 20,
            ['Length (cm)']: 15,
            ['Price (Ar)']: 10_000,
            ['Quantity']: 100,
            ['Pickup location']: 'latitude, longitude',
            ['Promotion discount (%)']: 10,
            ['Main photo']: 'product local image url',
            ['Photos']: 'product local images url (use "," to separate them)',
            ['Description']: 'product description',
         },
      ]
      exportFromJSON({
         data: exportData ?? [],
         fileName: `product-model`,
         exportType: 'xls',
      })
   }

   return (
      <div className='lg:h-[calc(100vh-90px)] space-y-2'>
         <div className='flex items-center justify-between'>
            <h1 className='font-bold text-2xl'>{translate('add_product')}</h1>
            <DropdownMenu>
               <DropdownMenuTrigger asChild>
                  <Button variant='outline'>
                     <Plus /> {translate('add_many')}
                  </Button>
               </DropdownMenuTrigger>
               <DropdownMenuContent>
                  <DropdownMenuItem asChild>
                     <label htmlFor='product_file'>
                        <Upload /> {translate('import_excel_file')}
                        <input
                           type='file'
                           id='product_file'
                           className='hidden'
                           accept='.xls,.xlsx,application/vnd.ms-excel,application/vnd.openxmlformats-officedocument.spreadsheetml.sheet'
                           onChange={(e) => {
                              console.log('upload excel file =>', e)
                              const file = e.target.files?.[0]
                              if (!file) return

                              const isExcel =
                                 file.type === 'application/vnd.ms-excel' ||
                                 file.type ===
                                    'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' ||
                                 /\.(xls|xlsx)$/i.test(file.name)

                              if (!isExcel) {
                                 alert(translate('please_select_an_excel_file'))
                                 e.target.value = ''
                                 return
                              }
                              dispatch(setFile(file))
                           }}
                        />
                     </label>
                  </DropdownMenuItem>
                  <DropdownMenuItem onClick={handleDownloadFile}>
                     <Download /> {translate('export_excel_model')}
                  </DropdownMenuItem>
               </DropdownMenuContent>
            </DropdownMenu>
         </div>
         <div className='grid lg:grid-cols-3 gap-4'>
            <AddMartProduct
               colors={colors}
               setColors={setColors}
               phoneNumber={phoneNumber}
               setPhoneNumber={setPhoneNumber}
               brand={brand}
               setBrand={setBrand}
               productName={productName}
               setProductName={setProductName}
               category={category}
               setCategory={setCategory}
               description={description}
               setDescription={setDescription}
               weight={weight}
               setWeight={setWeight}
               width={width}
               setWidth={setWidth}
               height={height}
               setHeight={setHeight}
               length={length}
               setLength={setLength}
               price={price}
               setPrice={setPrice}
               quantity={quantity}
               setQuantity={setQuantity}
               pickupLocation={pickupLocation}
               setPickupLocation={setPickupLocation}
               promotionDiscount={promotionDiscount}
               setPromotionDiscount={setPromotionDiscount}
            />

            <div className='flex flex-wrap lg:flex-col gap-4 overflow-hidden'>
               <SelectProductMainPhoto setMainPhoto={setMainPhoto} />
               <SelectProductPhotos />
            </div>
         </div>

         <div className='flex justify-end'>
            <Button className='bg-[var(--green-secondary)] hover:bg-[var(--green-secondary)] cursor-pointer text-[var(--green)] hover:scale-110'>
               <Save /> {translate('save')}
            </Button>
         </div>
      </div>
   )
}
